<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAZZ | Stealth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --spazz-purple: #bc13fe;
            --spazz-red: #ff0033;
            --bg-dark: #050505;
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .pulse-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pulse-core {
            width: 150px;
            height: 150px;
            background: var(--spazz-purple);
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.4;
            animation: breathe 4s infinite ease-in-out;
        }

        .inner-ring {
            position: absolute;
            width: 180px;
            height: 180px;
            border: 1px solid rgba(188, 19, 254, 0.2);
            border-radius: 50%;
            animation: spin 10s linear infinite;
        }

        .logo-text {
            position: absolute;
            font-weight: 700;
            letter-spacing: 8px;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 0 0 20px var(--spazz-purple);
        }

        #discovery-card {
            position: fixed;
            bottom: -400px;
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 20px;
            transition: bottom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            z-index: 100;
        }

        #discovery-card.active {
            bottom: 40px;
        }

        .user-tag {
            display: inline-block;
            background: rgba(188, 19, 254, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin: 5px;
            border: 1px solid var(--spazz-purple);
        }

        .status-label {
            margin-top: 50px;
            font-size: 0.7rem;
            letter-spacing: 3px;
            color: var(--spazz-purple);
            text-transform: uppercase;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.3); opacity: 0.6; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spazzing {
            animation: alert 0.2s infinite !important;
            background: var(--spazz-red) !important;
            filter: blur(20px) !important;
        }

        @keyframes alert {
            0% { transform: scale(1.1); }
            100% { transform: scale(1.2); }
        }
    </style>
</head>
<body>

    <div class="pulse-container">
        <div class="inner-ring"></div>
        <div id="core" class="pulse-core"></div>
        <div class="logo-text">SPAZZ</div>
    </div>

    <div class="status-label" id="status">Scanning the Void...</div>

    <div id="discovery-card">
        <div id="blind-content">
            <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; border: 2px dashed rgba(255,255,255,0.3);">
                üë§
            </div>
            <h2 style="font-size: 1.2rem; letter-spacing: 2px; color: #aaa;">UNKNOWN ENTITY</h2>
            <p style="font-size: 0.8rem; opacity: 0.7; margin: 15px 0;">Get closer to unlock this profile.</p>
        </div>

        <div id="revealed-content" style="display: none;">
            <h2 id="username">Unknown Entity</h2>
            <div id="tags">
                <span class="user-tag">#NEON</span>
                <span class="user-tag">#SPAZZ</span>
            </div>
            <p style="font-size: 0.8rem; opacity: 0.7; margin: 15px 0;">Signal locked. Connect?</p>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button id="lock-btn" style="background: rgba(255,255,255,0.1); border: 1px solid #fff; color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; width: 45%;">
                üîí LOCK ON
            </button>
            <button id="meet-btn" style="background: var(--spazz-purple); border: none; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; width: 45%;">
                ü§ù MEET
            </button>
        </div>
    </div>

    <script>
        const userId = "1"; // Your ID
        const core = document.getElementById('core');
        const statusText = document.getElementById('status');
        const card = document.getElementById('discovery-card');
        const apiPort = "8001"; // Port matched from main.py
        
        let lockedUserId = null;
        let currentNearbyUserId = null;

        // Set up event listeners securely
        document.getElementById('meet-btn').addEventListener('click', meetUser);
        document.getElementById('lock-btn').addEventListener('click', toggleLock);

        async function updateApp() {
            try {
                // Fetch from the correct port
                const res = await fetch(`http://127.0.0.1:${apiPort}/users`);
                const users = await res.json();
                
                // Find yourself
                const me = users.find(u => String(u.id) === userId);
                if (!me) return;
                
                let closestDist = 999;
                let nearbyUser = null;

                // Check proximity to others
                users.forEach(u => {
                    if (String(u.id) !== userId && u.type !== "wisp") {
                        const d = Math.sqrt(Math.pow(u.lat - me.lat, 2) + Math.pow(u.lon - me.lon, 2));
                        if (d < closestDist) {
                            closestDist = d;
                            nearbyUser = u;
                        }
                    }
                });

                // VISUAL & LOCK LOGIC
                if (nearbyUser && closestDist < 0.001) {
                    
                    if (!lockedUserId || String(nearbyUser.id) === lockedUserId) {
                        currentNearbyUserId = String(nearbyUser.id);
                        core.classList.add('spazzing');
                        statusText.innerText = "Entity Detected";
                        statusText.style.color = "#ff0033";
                        
                        // Keep card content blind until "Meet" is clicked
                        if (document.getElementById('revealed-content').style.display === 'none') {
                            document.getElementById('username').innerText = nearbyUser.username;
                        }
                        
                        card.classList.add('active');
                    }
                } else {
                    if (!lockedUserId) {
                        currentNearbyUserId = null;
                        core.classList.remove('spazzing');
                        statusText.innerText = "Scanning the Void...";
                        statusText.style.color = "#bc13fe";
                        card.classList.remove('active');
                        // Reset card to blind state
                        document.getElementById('blind-content').style.display = 'block';
                        document.getElementById('revealed-content').style.display = 'none';
                        const meetBtn = document.getElementById('meet-btn');
                        meetBtn.innerText = "ü§ù MEET";
                        meetBtn.removeEventListener('click', sendPing);
                        meetBtn.addEventListener('click', meetUser);
                    }
                }

            } catch (e) { console.log("Engine offline..."); }
        }

        // Blind Encounter: Reveal User
        function meetUser() {
            document.getElementById('blind-content').style.display = 'none';
            document.getElementById('revealed-content').style.display = 'block';
            const meetBtn = document.getElementById('meet-btn');
            meetBtn.innerText = "SEND PING";
            meetBtn.removeEventListener('click', meetUser);
            meetBtn.addEventListener('click', sendPing);
            
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        // Lock onto a specific user
        function toggleLock() {
            const lockBtn = document.getElementById('lock-btn');
            if (lockedUserId) {
                lockedUserId = null;
                lockBtn.innerText = "üîí LOCK ON";
                lockBtn.style.background = "rgba(255,255,255,0.1)";
            } else if (currentNearbyUserId) {
                lockedUserId = currentNearbyUserId;
                lockBtn.innerText = "üîì UNLOCK";
                lockBtn.style.background = "var(--spazz-red)";
            }
        }

        function sendPing() {
            alert("Ping sent to " + document.getElementById('username').innerText);
        }

        // Movement Controls
        window.addEventListener('keydown', async (e) => {
            // 1. Get current position from your data
            const res = await fetch(`http://127.0.0.1:${apiPort}/users`);
            const users = await res.json();
            const me = users.find(u => String(u.id) === userId);
            if (!me) return;

            let newLat = me.lat;
            let newLon = me.lon;
            const step = 0.0001; // Step size

            // 2. Calculate new position
            if (e.key === "ArrowUp") newLat += step;
            if (e.key === "ArrowDown") newLat -= step;
            if (e.key === "ArrowLeft") newLon -= step;
            if (e.key === "ArrowRight") newLon += step;
            
            // 3. Send new position to backend
            if (newLat !== me.lat || newLon !== me.lon) {
                await fetch(`http://127.0.0.1:${apiPort}/teleport/${userId}?lat=${newLat}&lon=${newLon}`, {method: 'POST'});
                updateApp(); // Refresh radar
            }
        });

        setInterval(updateApp, 1000);
    </script>
</body>
</html>